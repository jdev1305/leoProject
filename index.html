<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>R.H.V.Leonidas H13 - Goals Tracker 25/26</title>

  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial; background: #121212; color: #f0f0f0; margin: 20px; }
    h1 { text-align: center; margin-bottom: 20px; }
    .chart-container { display: flex; justify-content: center; margin-bottom: 30px; }
    canvas { max-width: 650px; width: 90%; background: #1e1e1e; padding: 10px; border-radius: 15px; }
    .week-header { margin-top: 30px; font-size: 1.4em; font-weight: bold; text-align: center; }
    table { width: 100%; max-width: 750px; margin: 10px auto; border-collapse: collapse; background: #1e1e1e; border-radius: 8px; overflow: hidden; }
    th, td { border-bottom: 1px solid #333; padding: 8px; text-align: center; }
    th { background: #007bff; color: #fff; }
    td button { background: #007bff; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin: 0 2px; }
    td button:hover { background: #0056b3; }
    .remove-btn { background: #ff4d4d; }
    .remove-btn:hover { background: #ff1a1a; }
    input { padding: 4px 6px; border-radius: 4px; border: none; }
  </style>
</head>
<body>
  <h1>R.H.V.Leonidas H13 - Goals Tracker 25/26</h1>

  <div class="chart-container">
    <canvas id="totalGoalsChart"></canvas>
  </div>

  <div id="results"></div>

  <script>
    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyCjNY4jonCkxLhdS9MQCg382l2y6pmPOc4",
      authDomain: "leonidasgoalstracker.firebaseapp.com",
      databaseURL: "https://leonidasgoalstracker-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "leonidasgoalstracker",
      storageBucket: "leonidasgoalstracker.appspot.com",
      messagingSenderId: "351370021203",
      appId: "1:351370021203:web:8d0ca697abc1646d4079a6",
      measurementId: "G-59JJEDNL8E"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const resultsDiv = document.getElementById("results");
    let chart;

    const goalsRef = db.ref('goals');

    // --- Ensure Weeks 1â€“10 exist ---
    goalsRef.once('value').then(snapshot => {
      let data = snapshot.val() || {};
      for (let i=1; i<=10; i++) {
        if (!data[`Week${i}`]) data[`Week${i}`] = {};
      }
      goalsRef.set(data, () => {
        goalsRef.on('value', snap => {
          const data = snap.val();
          if (data) renderAll(data);
        });
      });
    });

    function renderAll(data){
      renderTables(data);
      renderChart(data);
    }

    function renderTables(data){
      resultsDiv.innerHTML = '';
      Object.keys(data).sort((a,b)=>parseInt(a.replace('Week',''))-parseInt(b.replace('Week','')))
        .forEach(week=>{
          const weekData = data[week];
          let tableHTML = `<div class="week-header">${week}</div>
          <table>
            <tr><th>Player</th><th>Goals</th><th>Actions</th></tr>`;
          
          for(const player in weekData){
            tableHTML += `<tr>
              <td>${player}</td>
              <td>${weekData[player]}</td>
              <td>
                <button onclick="incrementGoal('${week}','${player}')">+1</button>
                <button onclick="decrementGoal('${week}','${player}')">-1</button>
                <button class="remove-btn" onclick="removeGoal('${week}','${player}')">X</button>
              </td>
            </tr>`;
          }

          // Add player row
          tableHTML += `<tr>
            <td><input type="text" id="${week}-newPlayer" placeholder="Player name"></td>
            <td><input type="number" id="${week}-newGoals" placeholder="Goals" min="1"></td>
            <td><button onclick="addPlayer('${week}')">Add</button></td>
          </tr>`;

          tableHTML += '</table>';
          resultsDiv.innerHTML += tableHTML;
        });
    }

    function renderChart(data){
      const totals = {};
      for(const week in data){
        for(const player in data[week]){
          totals[player] = (totals[player]||0)+data[week][player];
        }
      }
      const sortedTotals = Object.entries(totals).sort((a,b)=>b[1]-a[1]);
      const labels = sortedTotals.map(e=>e[0]);
      const values = sortedTotals.map(e=>e[1]);

      // Dynamically resize chart height
      const chartCanvas = document.getElementById('totalGoalsChart');
      const dynamicHeight = Math.max(labels.length * 40, 200); // at least 200px
      chartCanvas.style.height = dynamicHeight + 'px';

      const ctx = chartCanvas.getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx,{
        type:'bar',
        data:{
          labels,
          datasets:[{
            label:'Total Goals',
            data:values,
            backgroundColor:'#4BC0C0',
            hoverBackgroundColor:'#ff9800',
            borderRadius:10,
            barThickness:25,
            maxBarThickness:30
          }]
        },
        options:{
          indexAxis:'y',
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ display:false }},
          scales:{
            x:{ beginAtZero:true, ticks:{ precision:0 }, grid:{ color:'#333' }},
            y:{ grid:{ color:'#222' }, ticks:{ font:{ size:14, weight:'bold' }}}
          }
        }
      });
    }

    // --- Add Player inside table ---
    function addPlayer(week){
      const nameField = document.getElementById(`${week}-newPlayer`);
      const goalsField = document.getElementById(`${week}-newGoals`);
      const player = nameField.value.trim();
      const goals = parseInt(goalsField.value);

      if(!player || !goals || goals < 1) return alert("Enter valid player and goals");

      const playerRef = db.ref(`goals/${week}/${player}`);
      playerRef.transaction(currentValue => (currentValue || 0) + goals);

      nameField.value = '';
      goalsField.value = '';
    }

    // --- Increment Goals ---
    function incrementGoal(week, player){
      const playerRef = db.ref(`goals/${week}/${player}`);
      playerRef.transaction(currentValue => (currentValue || 0) + 1);
    }

    // --- Decrement Goals ---
    function decrementGoal(week, player){
      const playerRef = db.ref(`goals/${week}/${player}`);
      playerRef.transaction(currentValue => {
        if (!currentValue) return 0;
        return Math.max(currentValue - 1, 0);
      });
    }

    // --- Remove Player ---
    function removeGoal(week,player){
      if(confirm(`Remove ${player}'s goals for ${week}?`)){
        db.ref(`goals/${week}/${player}`).remove();
      }
    }
  </script>
</body>
</html>
